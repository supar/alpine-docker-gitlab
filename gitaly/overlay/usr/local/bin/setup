#!/bin/sh

# shellcheck disable=SC3040
set -eu -o pipefail

_strip_binaries() {
    dir=$1
    scanelf -BARF '' "$dir" | cut -d: -f1 | sort -u | xargs strip
}

fetch_source() {
    mkdir -p /tmp/src

    cd /tmp/src
    curl --fail \
        "https://gitlab.com/gitlab-org/gitaly/-/archive/v$GITALY_SERVER_VERSION/gitaly-v$GITALY_SERVER_VERSION.tar.gz" \
        | tar xzf - --strip-components=1
}

gitaly() {
    echo "Building gitaly"
    apk add \
        bash \
        binutils \
        cmake \
        curl \
        git \
        make \
        patch \
        ruby-bundler

    cd /tmp/src

    echo test

    patch -p0 -i /tmp/patches/gitaly-remove-ruby-bundle-from-build.patch
    patch -p0 -i /tmp/patches/gitaly-set-defaults.patch

    make build
    make install DESTDIR=/tmp/gitaly/

    _strip_binaries /tmp/gitaly
}

gitaly_git() {
    sudo chmod 0777 /tmp
    sudo apk add \
        bash \
        curl-dev \
        pcre2-dev \
        zlib-dev
    pwd

    cat >>config.mak <<-EOF
		GIT_BUILD_OPTIONS += NO_GETTEXT=YesPlease
		GIT_BUILD_OPTIONS += NO_REGEX=YesPlease
		GIT_BUILD_OPTIONS += NO_EXPAT=YesPlease
		GIT_BUILD_OPTIONS += NO_TCLTK=YesPlease
		GIT_BUILD_OPTIONS += NO_PERL=YesPlease
		GIT_BUILD_OPTIONS += USE_LIBPCRE2=YesPlease
		GIT_BUILD_OTPIONS += NO_SYS_POLL_H=1
		GIT_BUILD_OPTIONS += ICONV_OMITS_BOM=Yes
		GIT_BUILD_OPTIONS += NO_INSTALL_HARDLINKS=YesPlease
		GIT_BUILD_OPTIONS += DESTDIR=/tmp/git
		EOF
    make -j "$(nproc)" git GIT_PREFIX=/usr/local

    _strip_binaries /tmp/git
}

$1
