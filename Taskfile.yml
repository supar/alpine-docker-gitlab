# https://taskfile.dev

version: '3'

dotenv: [build-args.env]

env:
  DOCKER_BUILDKIT: 1

tasks:
  build-args:
    cmds:
      - GITLAB_VERSION=$(<GITLAB-VERSION) build/versions.sh >build-args.env
    generates:
      - build-args.env
    sources:
      - build/versions.sh
      - GITLAB-VERSION
    run: once

  .deploy-libs:
    label: "deploy-libs-{{.project}}"
    cmds:
      - |-
        [[ -z "{{.project}}" ]] && { echo "\$project not provided"; exit 1; }
        install -Dm0644 lib/* -t {{.project}}/build/lib/
    sources:
      - lib/libsetup
    generates:
      - "{{.project}}/build/lib/libsetup"
    run: when_changed

  build:
    deps:
      - build-gitlab-shell
      - build-gitaly
      - build-gitlab

  build-gitlab:
    cmds:
      - docker-compose build gitlab
    deps:
      - build-args
      - build-gitlab-shell
    sources:
      - overlay/*
      - overlay/**/*
      - Dockerfile

  deploy-libs-gitaly:
    cmds:
      - task: .deploy-libs
        vars: {project: gitaly}
  build-gitaly:
    cmds:
      - docker-compose build gitaly
    deps:
      - build-args
      - deploy-libs-gitaly
      - build-gitlab-shell
    sources:
      - gitaly/*
      - gitaly/**/*

  deploy-libs-gitlab-shell:
    cmds:
      - task: .deploy-libs
        vars: {project: gitlab-shell}
  build-gitlab-shell:
    cmds:
      - docker-compose build gitlab-shell
    deps:
      - build-args
      - deploy-libs-gitlab-shell
    sources:
      - gitlab-shell/*
      - gitlab-shell/**/*
    run: once
  config:
    cmds:
      - docker-compose config
